<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<style>
body {
	background-color: #201713 ;
}
.node {
	font-size: 8pt ;
	font-family: Arial, Helvetica, sans-serif ;
}
.potential {
	fill: #80a0c0 ;
}
.activated {
  stroke: none;
}

.link {
  stroke-opacity: .6;
  xxmarker-end: url(#arrow-marker);
}

.status {
	position: absolute ;
	top: 0 ;
	right: 0 ;
	text-align: right ;
	margin: 5px ;
	color: #80a0c0 ;
}
.pattern {
	position: absolute ;
	top: 0 ;
	left: 0 ;
	text-align: right ;
	margin: 5px ;
}
.pattern>input {
	width: 40px ;
	background-color: transparent ;
	border: none ;
	color: #80a0c0 ;
	font-size: 12pt ;
}

#chart {
	left: 0 ;
	top: 0 ;
	width: 100% ;
	height: 120px ;
	border: none ;
	padding: 0 ;
	overflow: hidden ;
}
.liquid {
	position: absolute ;
	left: 0 ;
	top: 120px ;
	width: 100% ;
	bottom: 0 ;
	border: none ;
	padding: 0 ;
	background-color: #050225 ;
	overflow: hidden ;
}

</style>
<title>SNN</title>
<script src="/d3.min.js"></script>
</head>
<body>
<div class="status"></div>
<div class="pattern">
	<input type="number" id='pattern-id' min=0 max=9 value="0" >
</div>

<canvas id="chart"  width='1200' height='150'></canvas>
<div id='liquid' class='liquid'></div>

<script type="text/javascript" charset="utf-8">

	var width = 800 ;
    var height = 600 ;
    var following = null ;
	
	const firingAge = d3.scaleLinear()
    			.domain( [ 0, 0.5, 2.0 ] )
    			.range(["green", "white", "red"]);

	const weightColor = d3.scaleLinear()
				.domain([-1, 0, 1])
				.range(["red", "white", "green"]);

	var svg = d3.select("#liquid").append("svg") 
		.attr("width", '100%')
		.attr("height", '100%')
		.attr("viewBox", "0 0 800 600")

	const width2 = svg.width ;
	
	var marker = svg.append( "marker" )
	.attr( "id", "arrow-marker" )
	.attr( "markerWidth", "50"  ) 
	.attr( "markerHeight", "50" )  
	.attr( "refX", "15"  ) 
	.attr( "refY", "3" ) 
	.attr( "orient", "auto" ) 
	.attr( "markerUnits", "userSpaceOnUse" ) ;

	marker.append( "path" )
	.attr( "d", "M0,0 L0,6 L9,3 z" )
	.attr( "fill", "#aaa"  ) ;

d3.json("data", function(error, graph) {
  if (error) return console.warn(error);

	function dragstarted(d) {
		if (!d3.event.active) simulation.alphaTarget(0.3).restart();
		d.fx = d.x;
		d.fy = d.y;
	}

	function dragged(d) {
		d.fx = d3.event.x;
		d.fy = d3.event.y;
	}

	function dragended(d) {
		if (!d3.event.active) simulation.alphaTarget(0);
		d.fx = null;
		d.fy = null;
	}

	const links = svg
	    .selectAll("line")
    	.data(graph.links)
    	.enter()
	    	.append("line") 
				.attr( 'id', function(l) { return l.id } )
				.attr( 'class', 'link' )
				.attr( "stroke", function(l) { return weightColor( l.weight ); })
		;

		const nodes = svg
    	.selectAll("circle.node")
    	.data( graph.nodes )
    	.enter()
			.append("circle")
				.attr( 'class', 'node' )
				.attr( 'id', function(d) { return d.id } )
				.attr( "r", function(d) { return 7.5 } ) 
				.attr( "stroke", "none" ) 
				.attr( "stroke-width", "5" ) 
				.attr( "fill", function(d) { 
					return firingAge( d.type ) 
				}) 
				.on( "click", function(d) { 
					neuronClicked( d.id ) 
				})
//				.call(d3.drag()
//					.on("start", dragstarted)
//					.on("drag", dragged)
//					.on("end", dragended)) 
  		;

		const texts = svg
    	.selectAll("text.potential")
    	.data( graph.nodes )
		.enter()
			.append( 'text' )
				.attr( 'class', 'potential' )
				.attr( 'font-size', '11pt')
				.attr( 'font-family', 'arial')
				.attr( 'id', function(d) { return 'txt-' + d.id } )
				.text( "0" )
  		;


  function tick() {
		nodes
		.attr("cx", function(d) { return d.x; })
		.attr("cy", function(d) { return d.y; })
		;
		texts
    	.attr("x", function(d) { return d.x+7; })
        .attr("y", function(d) { return d.y-3; })
    	;

    	links
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; })
    	;
	}

  const simulation = d3.forceSimulation()
	.nodes( graph.nodes )
	.force( "link", d3.forceLink()
//	 		.strength( function(l) { return .6 ; }) 
//	 		.distance( function(l) { return 15 ; } )
	 		.id( function(n) { return n.id ; } ) 
	 		.links( graph.links ) 
	 	)
	// .force( "charge", d3.forceManyBody()
	// 		.strength( -1 ) 
	// 	)
	//.force( "center", d3.forceCenter(width/2, height/2) )
	.force( "collide", d3.forceCollide( 30 ) ) 
	.force( "x", d3.forceX()
			.x( function(d) { 
				return d.fx ; 
			})
			.strength( function(d) { return 1 ; } ) 
		)  
	.force( "y", d3.forceY()
			.y( function(d) { 
				return d.fy  ; 
			})
			.strength( function(d) { return 1 ; } ) 
		)  
	.on("tick", tick ) 
	.on("end", tick ) 
	;

	neuronClicked( 0 ) ;
});


	
	var c = document.getElementById("chart");
	var ctx = c.getContext("2d");
	ctx.fillStyle = "#FF0000";

	var ws = null ;
	var intervalTimer = null ;
	const scoreDiv = document.querySelector( ".status" )

	function resetWebSocket() {
		console.log( "Resetting WS" ) 
		stopTimer()

		ws = new WebSocket( "ws://localhost:8111/live" )
		
		// called when a message received from server
		ws.onmessage = function (evt) {
			var data = JSON.parse( evt.data )
			
			scoreDiv.innerHTML = data.clock.toFixed(5) + " S<br>" + data.frequency.toFixed(2) + " Hz" ;

			for( var i=0 ; i<data.neurons.length ; i++ ) {			
				var n = document.getElementById( data.neurons[i].id )
				if( n ) {				
					n.style.fill = firingAge( data.neurons[i].ago*1000  ) 
				
					n = document.getElementById( 'txt-' + data.neurons[i].id )
					if( n ) {								
						n.textContent = (1000 * data.neurons[i].ago).toFixed(2) 
					}
				}
			}

			for( var i=0 ; i<data.edges.length ; i++ ) {			
				var e = document.getElementById( data.edges[i].id ) 
				if( e ) {				
					e.style.stroke = weightColor( data.edges[i].weight )  			
				}
			}
			
			c.width = c.width;	// clear screern ( of the chart area - not the graph )		
			
			const dx = c.width / data.history.length
			
			// Draw the chart at the top of the screen
			// chart od output values & which outputs are activated
			const outputColors = d3.scaleLinear()
				.domain([ 1.0, 2.0 ] )
				.range([ "orange", "steelblue"]);
			
			ctx.beginPath() ;
			ctx.strokeStyle = "steelblue"  
			ctx.moveTo( 0, 110-(100*history[i]) );
			for( var i=1 ; i<data.history.length ; i++ ) {
				ctx.lineTo( i*dx, 110-(100*data.history[i]) ) ;
			}
			ctx.stroke();
		};
		
		// called when socket connection established
		ws.onopen = function() {
			stopTimer() ;
			console.log("Connected.")
			if( following ) {
				sendToServer( "follow " + following.id ) ;	
			}
		};
		
		// called when socket connection closed
		ws.onclose = function() {
			console.log("Disconnected")
			stopTimer() ;
			intervalTimer = setInterval( resetWebSocket, 1000 ) ;
		};
		
		// called in case of an error
		ws.onerror = function(err) {
			console.log("ERROR!", err )
			stopTimer() ;
			intervalTimer = setInterval( resetWebSocket, 1000 ) ;
		};
	}

	function stopTimer() {
		if( intervalTimer ) {
			clearInterval( intervalTimer ) 
			intervalTimer = null 
		}
	}
	intervalTimer = setInterval( resetWebSocket, 1000 ) ;

	function neuronClicked( id ) {
		if( following ) {
			following.style.stroke = "none" ;  
		}
		following = document.getElementById( id ) ; 
		sendToServer( "follow " + id ) ;	
		if( following ) {
			following.style.stroke = "#ffff4d" ;  
		}
	}
	
	function updatePattern( id ) {
		sendToServer( "pattern " + id ) ;	
	}
	
	// sends msg to the server over websocket
	function sendToServer(msg) {
		if( ws ) ws.send(msg);
	}		
	
	window.addEventListener( "load", function(e) {
		const patternId = document.getElementById( "pattern-id" )
		patternId.addEventListener( "change", function(e) {
			updatePattern( e.target.value ) 
		})
	})
</script>

</body>
</html>